{"version":3,"file":"Component.js","sources":["../../component/Component.ts"],"sourcesContent":["import { Property } from \"../style/Property\";\r\nimport Gtk, { Delegate } from \"gtoolkit\";\r\n\r\nconst rootComponentMap: Map<mw.Widget, Component> = new Map();\r\n\r\nexport abstract class Component {\r\n    protected static create(): Component {\r\n        throw new Error(\"not implemented.\");\r\n    }\r\n\r\n    protected static defaultOption(): unknown {\r\n        throw new Error(\"not implemented.\");\r\n    }\r\n\r\n    private static destroyObject(component: Component) {\r\n        component._destroyed = true;\r\n        component.onDestroy.invoke();\r\n        rootComponentMap.get(component.root.parent)?._componentChildren.delete(component);\r\n\r\n        for (const componentChild of component._componentChildren.values()) {\r\n            componentChild.destroy();\r\n        }\r\n\r\n        if (component.renderAnimHandler) {\r\n            mw.TimeUtil.onEnterFrame.remove(component.renderAnim);\r\n        }\r\n        component.destruct();\r\n        component._root.constructor.prototype.destroyObject.call(component._root);\r\n        rootComponentMap.delete(component.root);\r\n    }\r\n\r\n    private _root: mw.Canvas;\r\n\r\n    private _componentChildren: Set<Component> = new Set();\r\n\r\n    private _destroyed: boolean = false;\r\n\r\n    public get destroyed(): boolean {\r\n        return this._destroyed;\r\n    }\r\n\r\n    protected initRoot(_root?: mw.Canvas): void {\r\n        this._root = _root ? _root :\r\n            mw.Canvas.newObject(undefined, \"root\");\r\n\r\n        rootComponentMap.set(this._root, this);\r\n\r\n        this._root.visibility = mw.SlateVisibility.SelfHitTestInvisible;\r\n        if (this._root.destroyObject === this._root.constructor.prototype.destroyObject) {\r\n            this._root.destroyObject = () => {\r\n                Component.destroyObject(this);\r\n            };\r\n        }\r\n        if (this.renderAnimHandler) {\r\n            mw.TimeUtil.onEnterFrame.add(this.renderAnim);\r\n        }\r\n    }\r\n\r\n    public get name(): string {\r\n        return this.constructor.name;\r\n    }\r\n\r\n    public get root(): mw.Canvas {\r\n        if (!this._root) this.initRoot();\r\n\r\n        return this._root;\r\n    }\r\n\r\n    public setLayout(option: ComponentOption): this {\r\n        if (this._root) {\r\n            if (option.zOrder !== undefined) this._root.zOrder = option.zOrder;\r\n\r\n            Gtk.setUiSize(this._root, option.size.x, option.size.y);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    protected destruct(): void {\r\n    }\r\n\r\n    public attach(canvas: mw.Canvas | Component): this {\r\n        if (canvas instanceof mw.Canvas) {\r\n            canvas.addChild(this.root);\r\n            rootComponentMap.get(canvas)?._componentChildren.add(this);\r\n        } else {\r\n            canvas.root.addChild(this.root);\r\n            canvas._componentChildren.add(this);\r\n        }\r\n\r\n        this.onAttach.invoke();\r\n        return this;\r\n    }\r\n\r\n    public detach() {\r\n        this.onDetach.invoke();\r\n        rootComponentMap.get(this.root)\r\n            ?._componentChildren.delete(this);\r\n        this._root?.removeObject();\r\n    }\r\n\r\n    public destroy() {\r\n        if (this._destroyed) return;\r\n        this._root?.destroyObject();\r\n    }\r\n\r\n//#region Anim\r\n    private renderAnim: (dt: number) => void = (dt) => {\r\n        if (this._root && this._root.visible) {\r\n            this.renderAnimHandler(dt);\r\n        }\r\n    };\r\n\r\n    protected renderAnimHandler: (dt: number) => void;\r\n//#endregion\r\n\r\n//#region Event\r\n    public onAttach: Delegate.SimpleDelegate<void> = new Delegate.SimpleDelegate<void>().setProtected();\r\n\r\n    public onDetach: Delegate.SimpleDelegate<void> = new Delegate.SimpleDelegate<void>().setProtected();\r\n\r\n    public onDestroy: Delegate.SimpleDelegate<void> = new Delegate.SimpleDelegate<void>().setProtected();\r\n//#endregion ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠐⠒⠒⠒⠒⠚⠛⣿⡟⠄⠄⢠⠄⠄⠄⡄⠄⠄⣠⡶⠶⣶⠶⠶⠂⣠⣶⣶⠂⠄⣸⡿⠄⠄⢀⣿⠇⠄⣰⡿⣠⡾⠋⠄⣼⡟⠄⣠⡾⠋⣾⠏⠄⢰⣿⠁⠄⠄⣾⡏⠄⠠⠿⠿⠋⠠⠶⠶⠿⠶⠾⠋⠄⠽⠟⠄⠄⠄⠃⠄⠄⣼⣿⣤⡤⠤⠤⠤⠤⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄\r\n}\r\n\r\nexport interface ComponentOption {\r\n    size?: { x: number, y: number };\r\n\r\n    padding?: Property.Padding;\r\n\r\n    zOrder?: number;\r\n}\r\n\r\n/**\r\n * Extract layout from option.\r\n * @param {ComponentOption} option\r\n * @returns {[\r\n * [number, number],\r\n * [number, number, number, number],\r\n * [number, number]\r\n * ]}\r\n *      [x,y]\r\n *      [pt, pr, pb, pl]\r\n *      [x - pl - pr, y - pt - pb]\r\n */\r\nexport function extractLayoutFromOption(option: ComponentOption): [\r\n    [number, number],\r\n    [number, number, number, number],\r\n    [number, number]] {\r\n    const [x, y] = [option.size.x, option.size.y];\r\n    const [pt, pr, pb, pl] = [option.padding.top ?? 0,\r\n        option.padding.right ?? 0,\r\n        option.padding.bottom ?? 0,\r\n        option.padding.left ?? 0,\r\n    ];\r\n    return [[x, y],\r\n        [pt, pr, pb, pl],\r\n        [x - pl - pr, y - pt - pb]];\r\n}\r\n\r\n/**\r\n * Override layout option.\r\n * @param {ComponentOption} self\r\n * @param {ComponentOption} from\r\n * @returns {ComponentOption}\r\n */\r\nexport function overrideOption(self: ComponentOption,\r\n                               from: ComponentOption): ComponentOption {\r\n    if (self === from) return;\r\n    if (from?.zOrder !== undefined) self.zOrder = from.zOrder;\r\n    if (from?.size !== undefined) {\r\n        if (from.size.x !== undefined) self.size.x = from.size.x;\r\n        if (from.size.y !== undefined) self.size.y = from.size.y;\r\n    }\r\n    if (from?.padding) {\r\n        if (from.padding.top !== undefined) self.padding.top = from.padding.top;\r\n        if (from.padding.right !== undefined) self.padding.right = from.padding.right;\r\n        if (from.padding.bottom !== undefined) self.padding.bottom = from.padding.bottom;\r\n        if (from.padding.left !== undefined) self.padding.left = from.padding.left;\r\n    }\r\n\r\n    return self;\r\n}"],"names":[],"mappings":"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"}